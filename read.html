<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Read Word</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" >
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <script src="https://unpkg.com/vue@3.5.22/dist/vue.global.js"></script>
  <script src="https://unpkg.com/naive-ui@2.42.0/dist/index.prod.js"></script>
  <style type="text/css">
    html { color: rgba(255, 255, 245, 0.86); }
    body { background: #1b1b1f; }
    #app { padding: 12px; }
    #audio { height: 30px; }
    .flex { width: 200px; }
    .textarea { min-height: 350px; height: 100%; }
    .wrapper-grid { display: flex; flex-direction: row; gap: 12px; }
    .item-grid { flex: 1; }
    .n-list .n-list-item { padding-left: 8px; }
    .n-input-number { text-align: center; }
    @media (max-width: 1000px) {
      .wrapper-grid { flex-direction: column; }
    }
  </style>
</head>
<body>
<div id="app">
  <n-config-provider :theme="darkTheme" :locale="zhCN" :date-locale="dateZhCN">
    <n-space vertical :size="12">
      <n-flex align="center">
        <n-switch :rail-style="railStyle" checked-value="1" unchecked-value="0" v-model:value="langType">
          <template #checked>英式</template>
          <template #unchecked>美式</template>
        </n-switch>
        <n-switch :rail-style="railStyle" checked-value="1" unchecked-value="0" v-model:value="voiceType">
          <template #checked>有道声源</template>
          <template #unchecked>本地声源</template>
        </n-switch>
        <audio id="audio" controls="controls" v-if="voiceType==1"></audio>
        <n-input-number v-model:value="voiceRate" :step="0.1" button-placement="both" round v-else>
          <template #prefix>语速</template>
        </n-input-number>
        <n-tree-select v-model:value="selectValue" :options="selectOptions" :indent="8" default-expand-all @update:value="handleSelectValue" class="flex" placeholder="请选择"></n-tree-select>
        <n-switch :rail-style="railStyle" checked-value="1" unchecked-value="0" v-model:value="sortType">
          <template #checked>顺序</template>
          <template #unchecked>随机</template>
        </n-switch>
      </n-flex>
      <div class="wrapper-grid">
        <div class="item-grid">
          <n-input v-model:value="inputValue" type="textarea" placeholder="请输入" class="textarea"></n-input>
        </div>
        <div class="item-grid">
          <n-list clickable hoverable>
            <n-list-item v-for="(item, index) in wordList" :key="index" @click="handlePlay(index)">{{ item.label }}</n-list-item>
          </n-list>
        </div>
      </div>
    </n-space>
  </n-config-provider>
</div>
<script src="./word_list_data.js"></script>
<script>
function playWordByAudio({ type, word }) {
  let audio = document.getElementById("audio")
  audio.src = `//dict.youdao.com/dictvoice?type=${type}&audio=${word}`
  audio.play()
}
function playWordByUtterance({ type, word, rate }) {
  let lang = type == "1" ? "en-GB" : "en-US"
  let data = new SpeechSynthesisUtterance()
  data.text = word
  data.lang = lang
  data.rate = rate
  data.onend = () => {}
  speechSynthesis.speak(data)
}
function setup(props, ctx) {
  const zhCN = naive.zhCN
  const dateZhCN = naive.dateZhCN
  const darkTheme = naive.darkTheme
  const railStyle = ({ checked }) => {
    let style = {}
    if(checked) {
      style.background = "#d03050"
    } else {
      style.background = "#2080f0"
    }
    return style
  }
  const langType = Vue.ref("1")
  const voiceType = Vue.ref("1")
  const voiceRate = Vue.ref(1)
  const sortType = Vue.ref("1")
  const inputValue = Vue.ref("")
  const selectValue = Vue.ref(null)
  const selectOptions = Vue.ref([])
  const handleSelectValue = value => {
    let index = word_list_data.findIndex(d => d.review_id == value)
    if(index > -1) {
      inputValue.value = word_list_data[index].content
    }
  }
  const wordListFormat = (word, index) => {
    if(word.indexOf("|") > 0) {
      let [wd, title] = word.split("|")
      let label = word.replace("|", " # ")
      return { word: wd, title, label: `${index+1}. ${label}`, index }
    }
    return { word, label: `${index+1}. ${word}`, index }
  }
  const wordList = Vue.computed(() => {
    if(inputValue.value) {
      let list = inputValue.value.split(/[\r\n]+/g)
      if(sortType.value == "1") {
        return list.map(wordListFormat)
      } else {
        return list.sort(() => Math.random() - 0.5).map(wordListFormat)
      }
    }
    return []
  })
  const playWord = word => {
    let type = langType.value
    let rate = voiceRate.value
    if(voiceType.value == 1) {
      playWordByAudio({ word, type })
    } else {
      playWordByUtterance({ word, type, rate })
    }
  }
  const shortMap = {
    sb: "somebody",
    sth: "something"
  }
  const handlePlay = (index) => {
    let { word } = wordList.value[index]
    word = word.split(" ").map(wd => shortMap[wd] || wd).join(" ")
    playWord(word)
  }
  const onMountedCallback = () => {
    let listMap = {}
    word_list_data.map(d => {
      let item = { label: `${d.title} # ${d.review_index}`, key: d.review_id, isLeaf: true }
      let category_key = `c-${d.review_at}-${d.category}`
      let category_label = d.category
      if(listMap[d.review_at]) {
        let index = listMap[d.review_at].children.findIndex(d => d.key == category_key)
        if(index > -1) {
          listMap[d.review_at].children[index].children.push(item)
        } else {
          listMap[d.review_at].children.push({ label: category_label, key: category_key, children:[item], disabled: true })
        }
      } else {
        let children = [{ label: category_label, key: category_key, children:[item], disabled: true }]
        listMap[d.review_at] = { label: d.review_at, key: `p-${d.review_at}`, children, disabled: true }
      }
    })
    selectOptions.value = Object.keys(listMap).map(name => listMap[name])
  }
  Vue.onMounted(onMountedCallback)
  return {
    zhCN,
    dateZhCN,
    darkTheme,
    railStyle,
    langType,
    voiceType,
    voiceRate,
    sortType,
    inputValue,
    selectValue,
    selectOptions,
    handleSelectValue,
    wordList,
    handlePlay
  }
}
const App = {
  setup
}
const app = Vue.createApp(App)
app.use(naive)
app.mount('#app')
</script>
</body>
</html>