<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Read Word</title>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" >
    <meta name="renderer" content="webkit">
    <style type="text/css">
      html { font-size: 24px; }
      body { text-align: center; font-size: 1rem; }
      .words, #input { flex: 1; min-height: 520px; }
      .words { border-style: solid; border-color: #ccc; border-width: 1px 1px 1px 0; background-color: #efefef; text-align: left; word-break: break-word; font-size: 1rem; }
      .words li { list-style: decimal-leading-zero; padding-left: 0.3rem; }
      .words a { display: inline-flex; padding: 0.3rem; cursor: pointer; white-space: nowrap; }
      .words a[selected] { color: red; }
      .words a:hover { color: red; }
      #input { font-size: 1rem; line-height: 1.5; }
      .btn { padding: 0 1rem; margin-right: 1rem; }
      #select { margin-left: 2rem; font-size: 1rem; }
      .wrapper { display:flex; max-width: 1200px; margin: 1rem auto; flex-direction: column; }
      .audio { display: flex; justify-content: center; margin-top: 1rem; }
      .audio input { width: 6rem; margin: 0 1rem; text-align:center; }
    </style>
</head>
<body>
<div>
  <input id="type0" name="type" type="radio" value="0" checked="checked" /><label for="type0">美式</label>
  <input id="type1" name="type" type="radio" value="1" /><label for="type1">英式</label>
  <select id="select"></select>
</div>
<div class="audio">
  <audio id="audio" controls="controls"></audio>
  <input type="number" value="3" id="count" />
  <input type="number" value="3" id="delay" />
  <button class="btn" id="btn">开始</button>
</div>
<div class="wrapper">
  <textarea id="input"></textarea>
  <div class="words" id="words_list"></div>
</div>
<script>
const word_list_data = [
"2025-9-6 yet|还 anyway|总之 already|已经 difference|差异 hate|讨厌 successful|有成就的 scientific|科学的 wise|明智的 present|现在完成时 row|一排",
]
</script>
<script>
let wordList = []
function updateWords(text) {
  let sl = []
  wordList = text.split(/[\r\n]+/g).map((wd, index) => {
    let word = wd.indexOf("$") > 0 ? wd.replace(/\$/g, ' ') : wd
    sl.push('<li><a class="word-' + index + '" onclick="play(' + index + ')">' + word + '</a></li>')
    return { word, index }
  })
  words_list.innerHTML = sl.join("")
  return text
}
function inputWords() {
  let text = input.value
  if(text != word_list_text) {
    updateWords(text)
    word_list_text = text
    localStorage.setItem("word-list-text", text)
  }
}
function selectWords() {
  let item = word_list_data[select.value]
  if(item) {
    let text = item.split(" ").slice(1).join("\r\n")
    input.value = updateWords(text)
  }
}
function playWord(word) {
  let type = document.querySelector("[name=type]:checked").value
  audio.src = '//dict.youdao.com/dictvoice?type=' + type + '&audio=' + word
  audio.play()
}
function play(index) {
  // playPause()
  // playWord(wordList[index].word)
  let type = document.querySelector("[name=type]:checked").value
  let lang = type == "1" ? "en-GB" : "en-US"
  let text = wordList[index].word
  let data = new SpeechSynthesisUtterance()
  data.text = text
  data.lang = lang
  data.rate = 0.8
  data.onend = () => {}
  speechSynthesis.speak(data)

}
function playHighlight(index) {
  let selector = "a.word-" + index
  let curr = words_list.querySelector("a[selected]")
  if(curr) {
    curr.removeAttribute("selected")
  }
  words_list.querySelector(selector).setAttribute("selected", "selected")
}
let timeID = null
let ended = null
let playing = false
function playPause() {
  playing = false
  btn.innerText = '开始'
  audio.pause()
  audio.removeEventListener("ended", ended)
  ended = null
  if(timeID) {
    clearTimeout(timeID)
  }
}
function playLoop() {
  if(playing) {
    playPause()
  } else if(wordList.length) {
    btn.innerText = '停止'
    playing = true
    let index = 0
    let t = 1
    let s = +count.value
    let d = +delay.value * 1000
    let next = () => {
      index++
      let word = wordList[index].word
      if(word) {
        playHighlight(index)
        playWord(word)
      } else {
        playing = false
        audio.removeEventListener("ended", ended)
        ended = null
      }
    }
    ended = () => {
      if(t < s) {
        t++
        timeID = setTimeout(() => { audio.play() }, d)
      } else {
        t = 1
        audio.pause()
        timeID = setTimeout(next, d)
      }
    }
    audio.addEventListener("ended", ended)
    playHighlight(index)
    playWord(wordList[index].word)
  }
}
let select = document.getElementById("select")
let input = document.getElementById("input")
let words_list = document.getElementById("words_list")
let audio = document.getElementById("audio")
let count = document.getElementById("count")
let delay = document.getElementById("delay")
let btn = document.getElementById("btn")
let reload = document.getElementById("reload")

let word_list_text = localStorage.getItem("word-list-text")
if(word_list_text) {
  input.value = updateWords(word_list_text)
}

if(word_list_data) {
  let options = ['<option>---请选择---</option>']
  word_list_data.map((item, index) => {
    let name = item.split(" ")[0]
    options.push('<option value="' + index + '">' + name + '</option>')
  })
  select.innerHTML = options.join("")
}

btn.addEventListener("click", playLoop, false)
input.addEventListener("blur", inputWords, false)
select.addEventListener("change", selectWords, false)
</script>
</body>
</html>